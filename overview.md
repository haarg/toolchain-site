# The Perl Toolchain

The Perl Toolchain is roughly the software involved with installing CPAN modules.

## CPAN Clients

A CPAN client fetches distributions, resolves dependencies, and runs the build,
test, and install processes.  Examples include cpan and cpanm.

  - Resolve module name to distribution file.
  - Download distribution file.
  - Extract configure dependencies.
  - Satisfy configure dependencies.
  - Configure dist.
  - Extract dependency modules.
  - Satisfy dependencies (recursively).
  - Run build.
  - Run test.
  - Run install.

### Resolving module names

Clients may use various mechanisms to resolve module names to dist packages.
The authoritative source of this data is the `02packages` file maintained by
PAUSE.  `CPAN.pm` uses this file directly.  Other clients may resolve these names
using other services, such as cpanmetadb or metacpan.

### Extract configure dependencies

The configure dependencies are those required to run the builder script.  They
are extracted from a `META.json`.

### Configure dist

A dist is configured by running its configure script.  This will be either a
`Makefile.PL` or `Build.PL` file.  `Build.PL` files should be preferred if they
exist.  This sets up files for the later steps.

Configuring a dist will generate files specifying the prerequisites.  The form
these prereqs are specified will depend on which configure tool you are using.
They are written to a `MYMETA.json` file.

### Extract dependencies

One of the things written by the configure phase is `MYMETA.json` file.  This
file is read to determine what prereqs must be installed.  Which phases and
relationships to include may be determined by the client.

### Run build

Running the build means running either 'make' if using a `Makefile.PL`, or
`./Build` if using a `Build.PL`.  This phase is meant to compile perl or XS
files as needed, and creating files in the blib directorty.  The internal
details of this are unspecified though.  Success or failure is communicated by
the exit status.

### Run test

Running tests means running either `make test` if using a `Makefile.PL` or
`./Build test` if using a `Build.PL`.  This phase will usually run `.t` files in
a directory named `t`, but any other process may be used.  Success or failure is
communicated by the exit status.  Some CPAN clients may skip this step.

### Run install

Installing means running either `make install` if using a Makefile.PL or
`./Build install` if using a Build.PL.

## Important EUMM or Module::Build Configuration

### `PERL_MM_OPT` and `PERL_MB_OPT`

### `INSTALL_BASE` and `--install_base`

### `INSTALLDIRS`

site vs perl (backcompat)

### `PREFIX`

## Configure Tools

A configure tool controls the build, test, and install actions.  It may also
calculate prereqs dynamically and communicate these to the CPAN client.

### ExtUtils::MakeMaker

### Module::Build

### Module::Install

### Module::Build::Tiny

## Author Tools

An author tool generates a dist file from source.

### ExtUtils::MakeMaker

### Module::Build

### Module::Install

### Dist::Zilla

## Test Tools

### Test Libraries

#### Test::More

#### Test::Needs

#### Test::Fatal

### Test Harnesses

#### Test::Harness

#### TAP::Harness

## Indexing tools

### cpanmetadb

### metacpan

## Important Files

### `Makefile.PL`

### `Build.PL`

### `MANIFEST`

### `MANIFEST.SKIP`

### `SIGNATURE`

### `Changes`

### `META.json` / `META.yml`

These files contain distribution metadata which is used cpan clients, indexing
services, and other uses.  They also include prerequisite information, although
it is often incomplete (aside from configure prereqs).  These files should be
generated by the author tool.  The json file contains data according to v2 of
the spec.  The yml file contains data according to v1.4 of the spec.

### `MYMETA.json` / `MYMETA.yml`

These files are used to communicate prerequisite information to a cpan client.
They should also include all of the information in the META files.  These files
are generated by the configure tool, and should not be included in
distributions.

### `dynamic_config`

With this meta value set to false, the dependencies specified in the META files
must be static and not calculated during the configure phase.  This means a
client can satisfy the dependencies without running the configure script.

### `x_static_install`

With this meta value set, the install process can be done directly by a CPAN
client or other external script.  The value is a version number of the static
install spec, which is currently in progress.

## versions

Perl has two forms of versions.  Etc.

## arch vs lib

## Backward compatibility

  - `META.yml` and `MYMETA.yml` files are also supported.  These files use v1.4
    of the CPAN meta spec, as opposed to the json files which contain v2 data.
    The v1.4 spec cannot specify prereqs as accurately, among other limitations.

  - CPAN.pm prior to X.XX (initially shipping in Perl 5.14) don't support
    configure prereqs.  If you want to support prior versions, your
    `Makefile.PL` or `Build.PL` should not require any non-core modules or
    versions.

  - Perl 5.8 does not ship with Module::Build or a `CPAN.pm` that understands
    `Build.PL`.  To support these perl versions, only a `Makefile.PL` using
    ExtUtils::MakeMaker should be used.

  - `Build.PL` was initially only used with Module::Build.  Since Module::Build
    is no longer shipping with perl and alternate modules can be used, it must
    be listed in configure prereqs.  Modern versions of Module::Build will do
    this automatically.  To support older dists, a CPAN client should treat
    the existence of a Build.PL as an implied configure prereq on Module::Build,
    unless the metadata specifies its own configure prereqs.

  - CPAN.pm prior to X.XX, EUMM prior to X.XX, and Module::Build prior to
    X.XX did not support MYMETA files.  Instead, the prerequisites were written
    into a header in the Makefile (for EUMM) or the file `_build/prereqs` (for
    Module::Build).  CPAN clients must also support this form of prerequisite
    extraction if they want to support older configure tools.  Configure tools
    must generate these files if they want to support older versions of CPAN.pm.

  - ExtUtils::MakeMaker has a long history and requires many backwards
    compatibility shims depending on how far back you want to support.  Many of
    the unsupported features will only cause warnings on older versions, and are
    not a problem as long as you are not using those old versions as an author.
    Version checks should be performed against a EUMM version like so:
    ```
        my $eumm_version = $ExtUtils::MakeMaker::VERSION;
        $eumm_version =~ tr/_//d;
        if ($eumm_version >= 6.57_02) { ... }
    ```
    - Ignorable
      * AUTHOR only supported a single value until 6.5705.
      * CONFIGURE_REQUIRES added in 6.52.
      * MIN_PERL_VERSION added in 6.48.
      * LICENSE added in 6.31.
      * META_MERGE added in 6.46.
      * META_ADD added in 6.46.
    - Fatal
      * TEST_REQUIRES support added in 6.64.  Should be collapsed into
        BUILD_REQUIRES on older versions.
      * BUILD_REQUIRES support added in 6.5503.  Should be collapsed into
        PREREQ_PM on older versions.
      * MYMETA support was broken when it was added in 6.57_02 until it was
        fixed in 6.57_07.  To support these versions, the NO_MYMETA option
        should be specified.

  - $] has a different floating point value than if the same number was used in
    perl source in some versions of perl.  Whenever doing perl version
    comparisons, $] should be stringified, then used with a numeric comparison.
    `"$]" >= 5.010`.

  - Test::More
    - done_testing
    - subtests
